<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
    integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="./css/style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js">
  </script>
  <!-- Let browser know website
        is optimized for mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>

  <div id="home" class="home layer d-none">
    <div class="collapse" id="navbarToggleExternalContent">
      <div id="navbar-items" class=" p-4">
        <h5 class="text-white h6">Menu</h5>
        <a href="#" class="text-light text-decoration-none h5" onclick="requestUsersInfo()">Register User</a>
      </div>
    </div>
    <nav id="navbar" class="navbar navbar-dark ">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold">Dynamic Digital Twin</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
          data-bs-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent"
          aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </nav>

    <div id="table" class="d-none layer table-responsive">
      <table id="table-div" class="table text-white table-responsive">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col" id="fname">Firstname</th>
            <th scope="col" id="lname">Lastname</th>
            <th scope="col" id="email-row">Email</th>
            <th scope="col" id="role-row">Role</th>
            <th scope="col" id="id-row" class="text-center">ID</th>
            <th scope="col" id="delete-row">Actions</th>


          </tr>
        </thead>
        <tbody id="tbody_users_table">

        </tbody>
      </table>
    </div>

    <div id="chat" class="d-none layer">
      <div class="chat-messages" id="chat-message"></div>

      <div class="typingMessage" style="display: flex;">
        <input type="text" class="messageBox" id="msg-box">
        <button class="btn" onclick="outputMessage()"><i class="fas fa-paper-plane" id="send-icon"></i></button>
      </div>
    </div>



    <div id="calender" class="d-none">
      <label style="color: white;" class="fs-3">
        Choose Date
        </label>
      <div id="calender-internal">
        <button type="button" class="btn btn-light d-inline-block" onclick="selectDate()">Select</button>
          <input type="date" name="bday" class="rounded" id="main-calender"/>
      </div>
      <div id="calender-btn-box">
          <p><button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModal3" onclick="addTodoBtn()">ADD TODO</button></p>

      </div>
      
    </div>

   

    <div class="modal fade" id="exampleModal3" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Add Task</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div>

              <div class="mb-3">
                <label for="" class="col-form-label">Title:</label>
                <input type="text" class="form-control" id="title-value">
              </div>
              <div class="mb-3">
                <input type="date" name="bday" class="rounded" id="calender-input" />
              </div>

            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="addTask()">Add Task</button>
          </div>
        </div>
      </div>
    </div>

    <div id="todo" class="">

    </div>

    <div class="modal fade modalDelete" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">User Info</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="user-name" class="col-form-label">UserID:</label>
                <input type="text" class="form-control" id="userId-input">
              </div>
              <div class="mb-3">
                <label for="email" class="col-form-label">Email:</label>
                <input type="email" class="form-control" id="email-input">
              </div>
              <div class="mb-3">
                <label for="f-name" class="col-form-label">Firstname:</label>
                <input type="text" class="form-control" id="fname-input">
              </div>
              <div class="mb-3">
                <label for="l-name" class="col-form-label">Lastname:</label>
                <input type="text" class="form-control" id="lname-input">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="editButtonUser()" id="edit-btn" data-bs-dismiss="modal">Edit</button>
            <button type="button" class="btn btn-danger" onclick="deleteTable()">Delete</button>
          </div>
        </div>
      </div>
    </div>
 
    <button type="button" class="btn btn-primary d-none" id="addUser-btn" data-bs-toggle="modal" data-bs-target="#exampleModal2" data-bs-whatever="@getbootstrap">Add NewUser</button>
    <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">New User</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="f-name" class="col-form-label">Firstname:</label>
                <input type="text" class="form-control" id="f-name-user">
              </div>
              <div class="mb-3">
                <label for="l-name" class="col-form-label">Lastname:</label>
                <input type="text" class="form-control" id="l-name-user">
              </div>
              <div class="mb-3">
                <label for="l-name" class="col-form-label">Email:</label>
                <input type="text" class="form-control" id="email-user">
              </div>
              <div class="mb-3">
                <label for="password" class="col-form-label">Password:</label>
                <input type="password" class="form-control" id="password-user">
              </div>
              <div class="mb-3">
                <label for="l-name" class="col-form-label">Role:</label>
                <input type="text" class="form-control" id="role-user">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="addNewUser()">Add User</button>
          </div>
        </div>
      </div>
    </div>


    <div class="main-enter d-flex" id="enter-exit">
      <p id="latlongNum" ></p>
      <p id="distanceNum" ></p>

      <button type="button" class="btn btn-success btn-lg" id="btn-Ex" onclick="exenBtn()">Enter</button>
    </div>

    <div class="tabs">
      <ul id="nav" class="nav nav-pills nav-fill">
        <li class="nav-item">
          <button class="nav-link active" onclick="chat()" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home"
            type="button" role="tab" aria-controls="pills-home" aria-selected="true">Chat</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile"
            type="button" role="tab" onclick="calender()" aria-controls="pills-profile" aria-selected="false">Calender</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-contact"
            type="button" role="tab" aria-controls="pills-contact" aria-selected="false">User</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-contact"
            type="button" role="tab" onclick="exitEnter()" aria-controls="pills-contact" aria-selected="false">Exit/Enter</button>
        </li>
      </ul>
    </div>
  </div>

  <div id="login" class="login d-none layer" style="z-index: 10000;">
    <div class="title pt-5">
      <h2 class="text-white text-center">Dynamic Digital Twin</h2>
    </div>
    <div style="padding: 20px;">
      <div>
        <div class="row mb-3">
          <label for="inputEmail3" class="col-sm-2 col-form-label text-white">Email</label>
          <div class="col-sm-10">
            <input type="email" class="form-control " id="inputEmail3" placeholder="Email">
          </div>
        </div>
        <div class="row mb-3">
          <label for="inputPassword3" class="col-sm-2 col-form-label text-white">Password</label>
          <div class="col-sm-10">
            <input type="password" class="form-control" id="inputPassword3" placeholder="Password">
          </div>
        </div> 
        <button id="btn-login"  type="button" class="btn btn-light" onclick="btnLog()">Login</button>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
</body>




<script type="text/javascript">
  LayerChange('login')
  var WS
  var todoID
  let userID
  var lastMessages

  if ("WebSocket" in window) {
    WS = new WebSocket("ws://localhost:2000");
    console.log('Ws supported');
    
    WS.onopen = function () {
      console.log('Connected to ws...');
      
      WS.send(JSON.stringify({ title: "sendMeDummyRequest" , data:{}}))
    };
    
    WS.onclose = function () {
      console.log('Connection lost!');
    };
  } else {
    console.log('Ws not supported!');
  }
  // KeepOnlineFunction, the interval time should be anything less than server maxAFK variable
  setInterval(() => WS.send(JSON.stringify({ title: "imOnline" , data:{}})), 2000)
  
  function btnLog() {
    const emailInput = document.getElementById('inputEmail3').value;
    const passwordInput = document.getElementById('inputPassword3').value;
    var data = {
      email: emailInput,
      password: passwordInput
    }
    WS.send(JSON.stringify({title: "login", data}))

  }

  function addToUsersTable(firstname, lastname, email, role , id) {
    var tbody_users_table = document.getElementById("tbody_users_table");
    tbody_users_table.innerHTML += `
    <tr>
      <tr id="table-selection">
        <th scope="row">1</th>
        <td>${firstname}</td>
        <td>${lastname}</td>
        <td>${email}</td>
        <td>${role}</td>
        <td >${id}</td>
        <td><button type="button" onclick="optionBtn()" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#exampleModal">Options</button></td>
        </tr>
        `
      }
      
      
      function addTodoBtn () {
        const mainDate = document.getElementById('main-calender').value
        const date = document.getElementById('calender-input').value = mainDate
        
      }
      
      function checkTodo (idE) {
        const idElement = idE.getAttribute('id');
        console.log(idElement);
        const todoTitle = document.getElementById(idElement).value
        var data = {
          tododone : true , 
          todoID : todoID
        }
        console.log(data);
        WS.send(JSON.stringify({title : "todoDone" , data}))
          document.getElementById(idElement).classList.add('text-decoration-line-through');
          return
      }
      
      function addTask() {
        const titleTask = document.getElementById('title-value').value;
        const date = document.getElementById('calender-input').value
        var data = {
          usertodo : titleTask ,
          date : date
        }
        console.log(data);
        WS.send(JSON.stringify({title:"addTask" , data}))
        console.log('datasended');
      }    
      
      function optionBtn () {
        var table = document.getElementById("table-div"),rIndex;
        for(var i = 1; i < table.rows.length; i++){
          table.rows[i].onclick = function(){
            rIndex = this.rowIndex;
            console.log(rIndex);
            document.getElementById("fname-input").value = this.cells[1].innerHTML;
            document.getElementById("lname-input").value = this.cells[2].innerHTML;
            document.getElementById("email-input").value = this.cells[3].innerHTML;
            const input = document.getElementById("id-row").value = this.cells[5].innerHTML;
            document.getElementById('userId-input').value = input
          };
        }
        
      }
      function addNewUser () {
        var fname = document.getElementById('f-name-user').value
        var lname = document.getElementById('l-name-user').value
        var email = document.getElementById('email-user').value
        var password = document.getElementById('password-user').value
        var role = document.getElementById('role-user').value
        
        var data = {
          firstname : fname ,
          lastname : lname ,
          email : email ,
          password : password ,
          role : role
        }
        console.log('added');
        WS.send(JSON.stringify({title: "addUser" , data}))
      }
      
      
      function deleteTable() {
      var input = document.getElementById('userId-input').value
      var data = {
        id : input
      }
      console.log(data);
      WS.send(JSON.stringify({title : "deleteUser" , data}))
    }
    
    function editButtonUser () {
      var fname = document.getElementById("fname-input").value 
      var lname = document.getElementById("lname-input").value 
      var email = document.getElementById("email-input").value    
      var input = document.getElementById('userId-input').value  
      
      var data = {
        firstname : fname ,
        lastname : lname ,
        email : email ,
        id : input ,
      }
      WS.send(JSON.stringify({title:'updateUser' , data}))
    }
    
    
    function requestUsersInfo() {
      console.log(1)
      LayerChange('table')
      // document.getElementById('table').classList.remove('d-none')
      // document.querySelector('.typingMessage').style.display = 'none'
    // document.getElementById('chat-message').style.display = 'none'
    WS.send(JSON.stringify({ title: "usersInfo", data: {}}));
  }
  
  function outputMessage() {
    const date = new Date()
    const hourAndMintute = Date.now()
    const message = document.getElementById('msg-box').value
    document.getElementById('msg-box').value = "";
    var data = {
      content : message ,
      userID : userID ,
      date : hourAndMintute
    }
    console.log(data);
    WS.send(JSON.stringify({ title: "chatMessage" , data}))
  }

  function selectDate () {
    document.getElementById('todo').innerHTML = ''
    const mainDate = document.getElementById('main-calender').value
    var data = {
      date : mainDate ,
    }
    console.log(data);
    WS.send(JSON.stringify({title:"userTodo" , data}))
    
  }
  
  
  
  
  function chat () {

    LayerChange('chatLayer')
  }
  
  function calender () {
    LayerChange('calender')
  }

  function exenBtn () {
    var data = {
      latitude : 35.682888 ,
      longitude : 51.371800
    }
    document.getElementById('latlongNum').innerHTML = `Your Latitude : ${data.latitude} , Longitude : ${data.longitude}`
    document.getElementById('btn-Ex').innerHTML = 'Exit'
    document.getElementById('btn-Ex').style.backgroundColor = 'red'

    WS.send(JSON.stringify({title:"myLocation" , data}))

  }

  function exitEnter () {
    LayerChange('Exit/Enter')
  }

  document.getElementById("btn-login").addEventListener('click', function () {
    btnLog();
  });
  
  
  WS.onmessage = function (eventRaw) {
    var event = JSON.parse(eventRaw.data) 
    if (event.title === "login") {
      if (event.state === "success") {
        WS.send(JSON.stringify({title:"lastMessages" , data : {}}))
        
        const btn = document.getElementById('btn-login').style.visibility = 'hidden'
        userID = event.userid
        console.log(userID);

        LayerChange('chat');

      } else {
        alert('check user info')
      }
      console.log(event);
    
    }

    
    if(event.title === "virtualAssist") {
      console.log (event.data)
    }

    console.log(event);
    if(event.title === "recentlyMessages") {
        console.log(event);
        lastMessages = event.data
        let last10Message = lastMessages.slice(Math.max(lastMessages.length -5,0))
        const chatMessage = document.querySelector('.chat-messages')
        last10Message.forEach((value) => {
          const currentElement = document.createElement('div')

          currentElement.classList.add('message')
          currentElement.innerHTML = `
          <label class="text">
          <span style = "display:block;">${value.userID}</span>
          ${value.content}
          <label><span style = "display:block;">${event.data[0].date}</span>`;
            
          chatMessage.appendChild(currentElement)
        })

    }

    if((event.title === "distance")) {

       document.getElementById('distanceNum').innerHTML = `Distance From Main Location : ${event.data}`
    }
    if ((event.title === "usersInfo")) {
      document.getElementById("tbody_users_table").innerHTML = ''
      for (i = 0; i < event.data.length; i++) {
        addToUsersTable(event.data[i].firstname, event.data[i].lastname, event.data[i].email, event.data[i].role , event.data[i]._id)
        
      }
    }
    

    if((event.title === "updatedTodo")) {
      console.log(event.data);
    } 
    
    if((event.title === "deletedUser")) {
      console.log(event);
      requestUsersInfo()
    } 





    
    if ((event.title === "broadcastChatMessage")) {
      const div = document.createElement('div');
        div.classList.add('message')
        console.log(event);
      
        div.innerHTML = `
        <label class="text">
        <span style = "display:block;">${userID}</span>
        ${event.data[0].content}
        <label><span style = "display:block;">${event.data[0].date}</span>`;

          document.querySelector('.chat-messages').appendChild(div)
        }
        
        if(event.title === "updatedUser") {
          console.log('updated');
          console.log(event);
          requestUsersInfo()
        }
        if(event.title === 'addedUser') {
          requestUsersInfo()
        }
        if(event.title === 'searchTodo') {
          console.log(event);
          for(var i=0 ; i < event.data.length ; i++) {
            console.log(event.data[i]);
          console.log(event.data[i]._id);
          todoID = event.data[i]._id
          console.log(todoID);
          var id = Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
          var inputId = Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
          console.log(event.data[i].usertodo);
          var dataTodo = event.data[i].usertodo
          var usertodo = checkbox
          const todoDiv = document.createElement('div')
          var checkbox = `
          <div class="input-group mb-3 inputTodo">
          <input type="text" class="form-control w-50" id="${id}"  value="${dataTodo}" aria-label="Text input with checkbox">
            <div class="input-group-text  ">
          <button type="button" class="btn btn-success" id="${id}" onclick="checkTodo(this)"><span class="material-symbols-outlined ">done</span></button>
         </div>
         `
         console.log(event.data[i].tododone);
         if(event.data[i].tododone === 'true') {
              checkbox = `
          <div class="input-group mb-3 inputTodo">
          <input type="text" class="form-control w-50 text-decoration-line-through" id="${id}"  value="${dataTodo}" aria-label="Text input with checkbox">
            <div class="input-group-text  ">
          <button type="button" class="btn btn-success" id="${id}" onclick="checkTodo(this)"><span class="material-symbols-outlined ">done</span></button>
         </div>
         `
            }
        // id="inp-todo"
        todoDiv.innerHTML = checkbox
        document.getElementById('todo').appendChild(todoDiv)

          }
        }
        // <input onclick="checkTodo()" class="form-check-input mt-0" type="checkbox" value="" aria-label="Checkbox for following text input">
        
        if(event.title === 'todoSaved') {
          console.log(event.data[0]._id);
          todoID = event.data[0]._id
          console.log(todoID);
          console.log(event.data._id);
          var id = Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
          var inputId = Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
          console.log(event.data[0].usertodo);
          var dataTodo = event.data[0].usertodo
          var usertodo = checkbox
          const todoDiv = document.createElement('div')
          var checkbox = `
          <div class="input-group mb-3 inputTodo">
          <input type="text" class="form-control w-50" id="${id}"  value="${dataTodo}" aria-label="Text input with checkbox">
            <div class="input-group-text  ">
          <button type="button" class="btn btn-success" id="${id}" onclick="checkTodo(this)"><span class="material-symbols-outlined ">done</span></button>
        </div>
      `
      // id="inp-todo"
      todoDiv.innerHTML = checkbox
      document.getElementById('todo').appendChild(todoDiv)
      
    }
  };

  function LayerChange(LayerName) {
    // Hide all divs with class
    var layers = document.getElementsByClassName("layer");
    console.log(layers.length);
    for (var i = 0; i < layers.length; i++) {
      //l.style.display = 'none';
      layers[i].classList.add('d-none')
    }

    switch (LayerName) {

      case 'Exit/Enter' : 
      document.getElementById('chat').classList.add('d-none')
      document.getElementById('home').classList.remove('d-none')
      document.getElementById('enter-exit').classList.remove('d-none')
      break;

      case 'calender' :
      document.getElementById('home').classList.remove('d-none')
      document.getElementById('calender').classList.remove('d-none')
      document.getElementById('calender').classList.add('d-flex')
      document.getElementById('addUser-btn').classList.add('d-none')
      document.getElementById('enter-exit').classList.add('d-none')
      
      break;

      case 'chatLayer' :
      document.getElementById('home').classList.remove('d-none')
      document.getElementById('addUser-btn').classList.add('d-none')
      document.getElementById('calender').classList.add('d-none')


      break;
      case 'chat':
        // document.getElementById('home').style.display = 'block'
        document.getElementById('chat').classList.remove('d-none')
        document.getElementById('home').classList.remove('d-none')
        document.getElementById('enter-exit').classList.add('d-none')
        break;
      case 'table':
        document.getElementById('addUser-btn').classList.remove('d-none')
        document.getElementById('table').classList.remove('d-none')
        document.getElementById('home').classList.remove('d-none')
        document.getElementById('calender').classList.add('d-none')
        document.getElementById('enter-exit').classList.add('d-none')
        break;
      case 'login':
        document.getElementById('login').classList.remove('d-none')
        break;
      default:
        document.getElementById('login').classList.remove('d-none')
    }
  }


</script>

</html>